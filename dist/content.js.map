{
  "version": 3,
  "sources": ["../src/shared/match.ts", "../src/content.ts"],
  "sourcesContent": ["const normalize = (value: string) =>\r\n  value\r\n    .toLowerCase()\r\n    .replace(/\\s+/g, \" \")\r\n    .replace(/[^a-z0-9 ]/g, \" \")\r\n    .trim();\r\n\r\nconst tokens = (value: string) => normalize(value).split(\" \").filter(Boolean);\r\n\r\nconst tokenOverlapScore = (query: string, text: string) => {\r\n  const q = tokens(query);\r\n  const t = new Set(tokens(text));\r\n  if (q.length === 0) return 0;\r\n  const hits = q.filter((item) => t.has(item)).length;\r\n  return hits / q.length;\r\n};\r\n\r\nconst subsequenceScore = (query: string, text: string) => {\r\n  const q = normalize(query);\r\n  const t = normalize(text);\r\n  if (!q || !t) return 0;\r\n  let qi = 0;\r\n  for (const ch of t) {\r\n    if (ch === q[qi]) qi += 1;\r\n    if (qi >= q.length) break;\r\n  }\r\n  return qi / q.length;\r\n};\r\n\r\nexport const scoreMatch = (query: string, text: string) => {\r\n  const exact = normalize(text).includes(normalize(query)) ? 1 : 0;\r\n  const overlap = tokenOverlapScore(query, text);\r\n  const subseq = subsequenceScore(query, text);\r\n  return Math.max(exact, overlap * 0.9, subseq * 0.7);\r\n};\r\n", "import { scoreMatch } from \"./shared/match\";\r\nimport type { ContentMessage, ContentResponse, SearchResult, TranscriptItem } from \"./shared/types\";\r\n\r\ntype CaptionTrack = {\r\n  baseUrl: string;\r\n  name?: { simpleText?: string };\r\n  languageCode?: string;\r\n  vssId?: string;\r\n};\r\n\r\ntype CaptionResponse = {\r\n  events?: Array<{\r\n    tStartMs?: number;\r\n    dDurationMs?: number;\r\n    segs?: Array<{ utf8?: string }>;\r\n  }>;\r\n};\r\n\r\nlet transcriptCache: Promise<TranscriptItem[]> | null = null;\r\n\r\nconst readCaptionTracksFromPage = (): Promise<CaptionTrack[]> =>\r\n  new Promise((resolve) => {\r\n    const messageId = `yt-prompt-jump-${Date.now()}-${Math.random().toString(16).slice(2)}`;\r\n\r\n    const handler = (event: MessageEvent) => {\r\n      if (event.source !== window) return;\r\n      const data = event.data as { source?: string; id?: string; tracks?: CaptionTrack[] };\r\n      if (data?.source !== \"yt-prompt-jump\" || data?.id !== messageId) return;\r\n      window.removeEventListener(\"message\", handler);\r\n      resolve(data.tracks ?? []);\r\n    };\r\n\r\n    window.addEventListener(\"message\", handler);\r\n\r\n    const script = document.createElement(\"script\");\r\n    script.textContent = `(() => {\r\n      const tracks = window.ytInitialPlayerResponse?.captions?.playerCaptionsTracklistRenderer?.captionTracks || [];\r\n      window.postMessage({ source: \"yt-prompt-jump\", id: \"${messageId}\", tracks }, \"*\");\r\n    })();`;\r\n    document.documentElement.appendChild(script);\r\n    script.remove();\r\n  });\r\n\r\nconst pickBestTrack = (tracks: CaptionTrack[]) => {\r\n  if (tracks.length === 0) return null;\r\n  const english = tracks.find((track) =>\r\n    [track.languageCode, track.vssId, track.name?.simpleText]\r\n      .filter(Boolean)\r\n      .join(\" \")\r\n      .toLowerCase()\r\n      .includes(\"en\")\r\n  );\r\n  return english ?? tracks[0];\r\n};\r\n\r\nconst fetchTranscript = async (): Promise<TranscriptItem[]> => {\r\n  const tracks = await readCaptionTracksFromPage();\r\n  const track = pickBestTrack(tracks);\r\n  if (!track?.baseUrl) {\r\n    throw new Error(\"No transcript found. Try a video with captions.\");\r\n  }\r\n\r\n  const url = `${track.baseUrl}&fmt=json3`;\r\n  const response = await fetch(url);\r\n  if (!response.ok) {\r\n    throw new Error(\"Unable to fetch transcript.\");\r\n  }\r\n\r\n  const data = (await response.json()) as CaptionResponse;\r\n  const items: TranscriptItem[] = [];\r\n\r\n  for (const event of data.events ?? []) {\r\n    const text = (event.segs ?? [])\r\n      .map((seg) => seg.utf8 ?? \"\")\r\n      .join(\"\")\r\n      .replace(/\\n/g, \" \")\r\n      .trim();\r\n\r\n    if (!text) continue;\r\n\r\n    items.push({\r\n      start: (event.tStartMs ?? 0) / 1000,\r\n      duration: (event.dDurationMs ?? 0) / 1000,\r\n      text\r\n    });\r\n  }\r\n\r\n  return items;\r\n};\r\n\r\nconst ensureTranscript = async () => {\r\n  if (!transcriptCache) {\r\n    transcriptCache = fetchTranscript();\r\n  }\r\n  return transcriptCache;\r\n};\r\n\r\nconst searchTranscript = async (query: string): Promise<SearchResult[]> => {\r\n  const transcript = await ensureTranscript();\r\n  const scored = transcript\r\n    .map((item) => ({\r\n      ...item,\r\n      score: scoreMatch(query, item.text)\r\n    }))\r\n    .filter((item) => item.score > 0.2)\r\n    .sort((a, b) => b.score - a.score || a.start - b.start)\r\n    .slice(0, 25);\r\n\r\n  return scored;\r\n};\r\n\r\nconst seekTo = (time: number) => {\r\n  const video = document.querySelector<HTMLVideoElement>(\"video\");\r\n  if (!video) return;\r\n  video.currentTime = Math.max(0, time);\r\n  video.play().catch(() => undefined);\r\n};\r\n\r\nchrome.runtime.onMessage.addListener(\r\n  (message: ContentMessage, _sender, sendResponse: (response: ContentResponse) => void) => {\r\n    if (message.type === \"search\") {\r\n      searchTranscript(message.query)\r\n        .then((results) => {\r\n          const info = results.length\r\n            ? `Found ${results.length} matches.`\r\n            : \"No matches found.\";\r\n          sendResponse({ type: \"search\", results, info });\r\n        })\r\n        .catch((error) => {\r\n          sendResponse({ type: \"error\", message: error?.message ?? \"Search failed.\" });\r\n        });\r\n      return true;\r\n    }\r\n\r\n    if (message.type === \"seek\") {\r\n      seekTo(message.time);\r\n      return false;\r\n    }\r\n\r\n    return false;\r\n  }\r\n);\r\n"],
  "mappings": "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",
  "names": []
}
